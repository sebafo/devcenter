name: Deploy Podcast App Example

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v2
      with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Decode JSON secret
      id: decode_json
      run: |
        echo "${{ vars.PARAMETERS_PODCAST_JSON }}" > parameters.json
        echo "BASE_PREFIX=fromJSON(parameters.json).parameters.basePrefix.value" >> $GITHUB_ENV
        echo "LOCATION=fromJSON(parameters.json).parameters.location.value" >> $GITHUB_ENV

    - name: Azure CLI script file
      uses: azure/cli@v2
      with:
        inlineScript: |
          DEPLOYMENT_NAME=${BASE_PREFIX}-deployment-$(date +%s)
          az deployment sub create --name $DEPLOYMENT_NAME --location ${LOCATION} --template-file main.bicep --parameters parameters.json --parameters gitHubPat=${{ secrets.PAT_GITHUB }}